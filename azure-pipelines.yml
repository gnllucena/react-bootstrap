trigger:
- main

variables:
  environment: 'gosample'
  registry: 'kubreg.azurecr.io'

stages:
- stage: Approval
  jobs:
  - deployment: 'WaitBuildApproval'
    environment: 'Build'
    pool:
      vmImage: 'ubuntu-20.04'
    strategy:
      runOnce:
        deploy:
          steps:
            - script: echo Approved
              displayName: 'Waiting build approval'

- stage: Build
  jobs:
  - job: 'BuildAndTest'
    pool:
      vmImage: 'ubuntu-20.04'
    steps:
      - task: NodeTool@0
        inputs:
          versionSpec: '10.x'
        displayName: 'Installing Node.js'
      - script: |
          yarn install
        displayName: 'Restoring dependencies'
      - script: |
          yarn run test
        displayName: 'Running tests'
      - task: PublishTestResults@2
        inputs:
          testResultsFiles: 'coverage/junit.xml'
        displayName: 'Publishing test results'
      - task: PublishCodeCoverageResults@1
        inputs:
          codeCoverageTool: 'Cobertura'
          summaryFileLocation: 'coverage/clover.xml'
        displayName: 'Publishing code coverage'
      - task: BuildQualityChecks@8
        inputs:
          allowCoverageVariance: true
          coverageVariance: 5
          coverageType: branch
          checkCoverage: true
          coverageThreshold: 1
          coverageUpperThreshold: 1
          coverageDeltaType: percentage
        displayName: 'Checking build quality'
      - script: yarn run build
        env:
          NODE_OPTIONS: --max_old_space_size=16384
        displayName: 'Creating artifact'
      - publish: $(System.DefaultWorkingDirectory)/dist
        artifact: app
        displayName: 'Publishing app artifact'

- stage: Staging
  jobs:
  - deployment: 'DeployStaging'
    environment: 'Staging'
    pool:
      vmImage: 'ubuntu-20.04'
    strategy:
      runOnce:
        deploy:
          steps:
            - task: NodeTool@0
              inputs:
                versionSpec: '10.x'
              displayName: 'Installing Node.js'
            - script: |
                yarn install
              displayName: 'Restoring dependencies'
            - script: |
                yarn run test
              displayName: 'Running tests'
            - script: |
                yarn run build
              displayName: 'Creating package'
            - publish: $(System.DefaultWorkingDirectory)/dist
              artifact: WebApp
