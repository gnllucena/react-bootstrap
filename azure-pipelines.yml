# Node.js with React
# Build a Node.js project that uses React.
# Add steps that analyze code, save build artifacts, deploy, and more:
# https://docs.microsoft.com/azure/devops/pipelines/languages/javascript
trigger:
- main

variables:
  imageName: 'gosample'
  registry: 'kubreg.azurecr.io'

stages:
- stage: Build
  jobs:
  - job: 'BuildAndTest'
    pool:
      vmImage: 'ubuntu-latest'
    steps:
      - task: NodeTool@0
        inputs:
          versionSpec: '10.x'
        displayName: 'Installing Node.js'
      - script: |
          yarn install
        displayName: 'Restoring dependencies'
      - script: |
          yarn run test
        displayName: 'Running tests'
      - task: PublishCodeCoverageResults@1
        inputs:
          codeCoverageTool: 'Cobertura'
          summaryFileLocation: 'coverage/cobertura-coverage.xml'
        displayName: 'Publishing code coverage'
      - task: BuildQualityChecks@8
        inputs:
          coverageType: lines
          checkCoverage: true
          coverageThreshold: '5'
        displayName: 'Checking build quality'
      - script: yarn run build
        env:
          NODE_OPTIONS: --max_old_space_size=16384
        displayName: 'Creating artifact'
      - publish: $(System.DefaultWorkingDirectory)/dist
        artifact: app
        displayName: 'Publishing app artifact'
- stage: Staging
  jobs:
  - job: 'Deploy'
    pool:
      vmImage: 'ubuntu-latest'
    steps:
      - task: NodeTool@0
        inputs:
          versionSpec: '10.x'
        displayName: 'Installing Node.js'
      - script: |
          yarn install
        displayName: 'Restoring dependencies'
      - script: |
          yarn run test
        displayName: 'Running tests'
      - script: |
          yarn run build
        displayName: 'Creating package'
      - publish: $(System.DefaultWorkingDirectory)/dist
        artifact: WebApp
